# ZORA CORE Next.js Deployment with INFINITY INJEKTIONâ„¢ Integration
#
# Enhanced workflow for building and deploying a Next.js site to GitHub Pages
# Includes INFINITY INJEKTIONâ„¢ contact system validation and integration
#
name: Deploy Next.js site to Pages with INFINITY INJEKTIONâ„¢

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

# INFINITY INJEKTIONâ„¢ Environment Variables
env:
  ZORA_HQ_ADDRESS: "Fjordbakken 50, Dyves Bro, 4700 NÃ¦stved"
  ZORA_CVR: "37750514"
  ZORA_EMAIL: "kontakt@zoracore.dk"
  ZORA_P_ENHEDER: "KOBBERHJÃ˜RNET x ORINGE"
  INFINITY_MODE: "true"

jobs:
  # Build job with INFINITY INJEKTIONâ„¢
  build:
    name: Build with INFINITY INJEKTIONâ„¢
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: â™¾ï¸ Validate INFINITY INJEKTIONâ„¢ Contact System
        run: |
          echo "ğŸ” Validating ZORA CORE INFINITY INJEKTIONâ„¢ Contact System..."
          
          # Check if contact configuration exists
          if [ -f "zora_contact_config.py" ]; then
            echo "âœ… Contact configuration found"
          else
            echo "âŒ Contact configuration missing"
            exit 1
          fi
          
          # Check if footer component exists
          if [ -f "components/zora_footer.py" ]; then
            echo "âœ… Footer component found"
          else
            echo "âŒ Footer component missing"
            exit 1
          fi
          
          # Check if CSS exists
          if [ -f "static/css/zora_contact.css" ]; then
            echo "âœ… Contact CSS found"
          else
            echo "âŒ Contact CSS missing"
            exit 1
          fi
          
          # Check if legal templates exist
          if [ -f "legal_templates/zora_legal_footer.py" ]; then
            echo "âœ… Legal templates found"
          else
            echo "âŒ Legal templates missing"
            exit 1
          fi
          
          echo "ğŸ¢ ZORA HQ: ${{ env.ZORA_HQ_ADDRESS }}"
          echo "ğŸ›ï¸ CVR: ${{ env.ZORA_CVR }}"
          echo "ğŸ“§ Email: ${{ env.ZORA_EMAIL }}"
          echo "ğŸ“ P-enheder: ${{ env.ZORA_P_ENHEDER }}"
          echo "â™¾ï¸ INFINITY MODE: ${{ env.INFINITY_MODE }}"
          echo "âœ… INFINITY INJEKTIONâ„¢ validation completed successfully"
          
      - name: Setup Python for Contact Validation
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      - name: ğŸ§ª Test Contact System Integration
        run: |
          echo "ğŸ§ª Testing ZORA CORE contact system integration..."
          python3 -c "
          try:
              from zora_contact_config import ZORA_CONTACT_INFO, get_full_contact_data, validate_contact_info
              print('âœ… Contact configuration imports successfully')
              
              validation = validate_contact_info()
              if validation['all_requirements_met']:
                  print('âœ… Contact validation passed')
              else:
                  print('âŒ Contact validation failed')
                  exit(1)
                  
              contact_data = get_full_contact_data('en')
              print(f'âœ… Contact data generated: {len(str(contact_data))} characters')
              print('â™¾ï¸ INFINITY INJEKTIONâ„¢ contact system operational')
          except Exception as e:
              print(f'âŒ Contact system test failed: {e}')
              exit(1)
          "
          
      - name: Detect package manager
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            echo "command=install" >> $GITHUB_OUTPUT
            echo "runner=yarn" >> $GITHUB_OUTPUT
            exit 0
          elif [ -f "${{ github.workspace }}/package.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
            echo "runner=npx --no-install" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Unable to determine package manager"
            exit 1
          fi
          
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: ${{ steps.detect-package-manager.outputs.manager }}
          
      - name: Setup Pages
        uses: actions/configure-pages@v5
        with:
          # Automatically inject basePath in your Next.js configuration file and disable
          # server side image optimization (https://nextjs.org/docs/api-reference/next/image#unoptimized).
          #
          # You may remove this line if you want to manage the configuration yourself.
          static_site_generator: next
          
      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          # Generate a new cache whenever packages or source files change.
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          # If source files changed but packages didn't, rebuild from a prior cache.
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}-
            
      - name: Install dependencies
        run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}
        
      - name: ğŸŒ Pre-build Contact Integration Check
        run: |
          echo "ğŸŒ Verifying contact integration before build..."
          
          # Check HTML files for contact footer integration
          if grep -q "INFINITY INJEKTION" index.html; then
            echo "âœ… index.html has INFINITY INJEKTIONâ„¢ integration"
          else
            echo "âš ï¸ index.html missing INFINITY INJEKTIONâ„¢ integration"
          fi
          
          if grep -q "zora-infinity-footer" index.html; then
            echo "âœ… index.html has footer classes"
          else
            echo "âš ï¸ index.html missing footer classes"
          fi
          
          echo "â™¾ï¸ Pre-build validation completed"
          
      - name: Build with Next.js + INFINITY INJEKTIONâ„¢
        run: |
          echo "ğŸš€ Building Next.js site with INFINITY INJEKTIONâ„¢ integration..."
          ${{ steps.detect-package-manager.outputs.runner }} next build
          echo "âœ… Next.js build completed with INFINITY INJEKTIONâ„¢"
          
      - name: ğŸ” Post-build Contact Verification
        run: |
          echo "ğŸ” Verifying INFINITY INJEKTIONâ„¢ integration in build output..."
          
          # Check if contact information is present in built files
          if find ./out -name "*.html" -exec grep -l "kontakt@zoracore.dk" {} \; | head -1; then
            echo "âœ… Contact email found in build output"
          else
            echo "âŒ Contact email missing from build output"
            exit 1
          fi
          
          if find ./out -name "*.html" -exec grep -l "37750514" {} \; | head -1; then
            echo "âœ… CVR found in build output"
          else
            echo "âŒ CVR missing from build output"
            exit 1
          fi
          
          if find ./out -name "*.html" -exec grep -l "KOBBERHJÃ˜RNET x ORINGE" {} \; | head -1; then
            echo "âœ… P-enheder structure found in build output"
          else
            echo "âŒ P-enheder structure missing from build output"
            exit 1
          fi
          
          echo "â™¾ï¸ INFINITY INJEKTIONâ„¢ post-build verification completed successfully"
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  # Deployment job with INFINITY INJEKTIONâ„¢
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    name: Deploy with INFINITY INJEKTIONâ„¢
    steps:
      - name: ğŸš€ Deploy to GitHub Pages with INFINITY INJEKTIONâ„¢
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: â™¾ï¸ Post-deployment INFINITY Notification
        run: |
          echo "ğŸ‰ ZORA CORE Next.js site deployed successfully!"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "â™¾ï¸ INFINITY INJEKTIONâ„¢ contact system is now live"
          echo "ğŸ“§ Contact: kontakt@zoracore.dk"
          echo "ğŸ›ï¸ CVR: 37750514"
          echo "ğŸ“ P-enheder: KOBBERHJÃ˜RNET x ORINGE"
          echo "âœ… Deployment completed with full INFINITY INJEKTIONâ„¢ integration"
