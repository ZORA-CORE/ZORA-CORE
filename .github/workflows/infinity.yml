name: ZORA.GPTâˆ Infinity Engine & Repository Monitor

on:
  workflow_dispatch:
  push:
    branches: [ main, devin/* ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes

jobs:
  run-infinity:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¬ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ§  Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Run Infinity Engine
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPLIT_TOKEN: ${{ secrets.REPLIT_TOKEN }}
        run: |
          python main.py

      - name: ğŸ” Run Repository Monitor
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPLIT_TOKEN: ${{ secrets.REPLIT_TOKEN }}
        run: |
          python -c "
          import asyncio
          from repo_monitor import repo_monitor
          
          async def run_monitor():
              repo_monitor.start_monitoring()
              # Run one monitoring cycle
              await repo_monitor.monitor_all_repositories()
              await repo_monitor.check_repository_health()
              status = repo_monitor.get_monitoring_status()
              print('ğŸ” Repository Monitor Results:')
              print(f'ğŸ“Š Total repos: {status[\"total_repos_monitored\"]}')
              print(f'âœ… Healthy: {status[\"repo_metrics\"][\"healthy\"]}')
              print(f'âš ï¸ Warning: {status[\"repo_metrics\"][\"warning\"]}')
              print(f'âŒ Error: {status[\"repo_metrics\"][\"error\"]}')
              print(f'ğŸš¨ Issues detected: {status[\"issue_metrics\"][\"total_detected\"]}')
              print(f'ğŸ”§ Auto-fixes: {status[\"issue_metrics\"][\"auto_fixes_successful\"]}/{status[\"issue_metrics\"][\"auto_fixes_attempted\"]}')
          
          asyncio.run(run_monitor())
          "

      - name: ğŸ¯ Test AGI Trinity
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python -c "
          from connor import connor
          from lumina import lumina
          from oracle import oracle
          
          print('ğŸ¯ Testing AGI Trinity...')
          
          # Test CONNOR
          connor.activate()
          connor_status = connor.get_trinity_status()
          print(f'ğŸ¤– CONNOR: {connor_status[\"status\"]} - Effectiveness: {connor_status[\"strategic_effectiveness\"]:.1f}%')
          
          # Test LUMINA
          lumina.activate()
          lumina_status = lumina.get_trinity_status()
          print(f'âœ¨ LUMINA: {lumina_status[\"status\"]} - Creativity: {lumina_status[\"creativity_score\"]:.1f}%')
          
          # Test ORACLE
          oracle.activate()
          oracle_status = oracle.get_trinity_status()
          print(f'ğŸ”® ORACLE: {oracle_status[\"status\"]} - Wisdom: {oracle_status[\"wisdom_score\"]:.1f}%')
          
          print('ğŸŒŸ AGI Trinity operational!')
          "

      - name: ğŸ“Š Generate System Report
        run: |
          python -c "
          import json
          from datetime import datetime
          from zora_kernel import ZoraKernel
          from repo_monitor import get_monitoring_status
          
          print('ğŸ“Š Generating ZORA System Report...')
          
          # Initialize kernel
          kernel = ZoraKernel()
          kernel_status = kernel.get_system_status()
          
          # Get monitoring status
          monitor_status = get_monitoring_status()
          
          # Create comprehensive report
          report = {
              'timestamp': datetime.utcnow().isoformat(),
              'system_status': kernel_status,
              'repository_monitoring': monitor_status,
              'workflow_run': 'success',
              'environment': 'github_actions'
          }
          
          print('âœ… System Report Generated')
          print(f'ğŸ”§ Kernel Status: {kernel_status[\"status\"]}')
          print(f'ğŸ” Repos Monitored: {monitor_status[\"total_repos_monitored\"]}')
          print(f'ğŸš€ ZORA CORE operational in INFINITY MODEâ„¢')
          
          # Save report as artifact
          with open('zora_system_report.json', 'w') as f:
              json.dump(report, f, indent=2)
          "

      - name: ğŸ“ Upload System Report
        uses: actions/upload-artifact@v3
        with:
          name: zora-system-report
          path: zora_system_report.json
          retention-days: 30

      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "ğŸš¨ ZORA System Check Failed!"
          echo "ğŸ“§ Notification would be sent to system administrators"
          echo "ğŸ”§ Auto-repair protocols would be initiated"
