# ZORA MODULE HEADER

"""
Module Name: zora
Generated by ZORA SYSTEM â€“ All rights reserved.
ZORA Core API - Comprehensive External Interaction System
"""

import asyncio
import time
import logging
from typing import Dict, Any, List, Optional
from datetime import datetime
from fastapi import FastAPI, HTTPException, Depends, Security, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from pydantic import BaseModel, Field
import uvicorn

from zora_kernel import zora_kernel
from ZORA_UNIVERSAL_HUB import universal_hub, coordinate_ai_agents, get_universal_status
from infinity import infinity_engine, add_infinity_task, TaskPriority, get_infinity_status
from sync_utils import get_sync_status
from agents import *

class AgentPingRequest(BaseModel):
    agent_name: str = Field(..., description="Name of the agent to ping")
    message: str = Field(default="API ping", description="Message to send to agent")

class CoordinationRequest(BaseModel):
    agent_group: Optional[str] = Field(None, description="Specific agent group to coordinate")
    message: str = Field(default="API coordination", description="Coordination message")

class TaskRequest(BaseModel):
    name: str = Field(..., description="Task name")
    priority: str = Field(default="medium", description="Task priority: critical, high, medium, low, background")
    agent_group: Optional[str] = Field(None, description="Agent group for coordinated execution")
    metadata: Dict[str, Any] = Field(default_factory=dict, description="Additional task metadata")

class ModuleRegistrationRequest(BaseModel):
    module_name: str = Field(..., description="Name of the module to register")
    config: Dict[str, Any] = Field(default_factory=dict, description="Module configuration")

class BusinessIntegrationRequest(BaseModel):
    business_name: str = Field(..., description="Name of the business to integrate")
    ethical_review: bool = Field(default=True, description="Whether to perform ethical review")
    config: Dict[str, Any] = Field(default_factory=dict, description="Integration configuration")

security = HTTPBearer()

class ZoraAPIAuth:
    """ZORA API Authentication System"""
    
    def __init__(self):
        self.valid_tokens = {
            "zora_admin_token": "admin",
            "zora_user_token": "user",
            "zora_readonly_token": "readonly"
        }
        self.logger = logging.getLogger("zora.api.auth")
    
    def verify_token(self, credentials: HTTPAuthorizationCredentials = Security(security)) -> str:
        """Verify API token and return user role"""
        token = credentials.credentials
        
        if token in self.valid_tokens:
            role = self.valid_tokens[token]
            self.logger.info(f"API access granted for role: {role}")
            return role
        else:
            self.logger.warning(f"Invalid API token attempted: {token[:10]}...")
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid authentication token",
                headers={"WWW-Authenticate": "Bearer"},
            )

app = FastAPI(
    title="ZORA CORE API",
    description="ZORA Core Comprehensive External Interaction System",
    version="2.0.0",
    docs_url="/docs",
    redoc_url="/redoc"
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Configure appropriately for production
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

auth = ZoraAPIAuth()

api_logger = logging.getLogger("zora.api")
api_logger.setLevel(logging.INFO)

@app.middleware("http")
async def log_requests(request, call_next):
    """Log all API requests"""
    start_time = time.time()
    
    api_logger.info(f"API Request: {request.method} {request.url}")
    
    response = await call_next(request)
    
    process_time = time.time() - start_time
    api_logger.info(f"API Response: {response.status_code} - {process_time:.3f}s")
    
    return response

@app.get("/", tags=["Core"])
def read_root():
    """ZORA Core API root endpoint"""
    return {
        "message": "ZORA CORE API is live â€” Powered by CONNOR & LUMINA & ORACLE",
        "version": "2.0.0",
        "timestamp": datetime.utcnow().isoformat(),
        "founder": "MADS PALLISGAARD",
        "infinity_mode": True,
        "endpoints": {
            "docs": "/docs",
            "status": "/status",
            "system": "/system/*",
            "agents": "/agents/*",
            "coordination": "/coordination/*",
            "infinity": "/infinity/*",
            "hub": "/hub/*"
        }
    }

@app.get("/status", tags=["Core"])
def status():
    """Basic system status"""
    return {
        "status": "OK",
        "source": "ZORA Core FastAPI",
        "timestamp": datetime.utcnow().isoformat(),
        "infinity_active": infinity_engine.is_running,
        "coordination_active": universal_hub.coordination_active,
        "kernel_status": "operational"
    }

@app.get("/system/status", tags=["System"])
def get_system_status(role: str = Depends(auth.verify_token)):
    """Get comprehensive system status"""
    try:
        kernel_status = zora_kernel.get_system_status()
        hub_status = get_universal_status()
        infinity_status = get_infinity_status()
        sync_status = get_sync_status()
        
        return {
            "timestamp": datetime.utcnow().isoformat(),
            "system_health": "operational",
            "kernel": kernel_status,
            "universal_hub": hub_status,
            "infinity_engine": infinity_status,
            "sync_system": sync_status,
            "api_version": "2.0.0"
        }
    except Exception as e:
        api_logger.error(f"System status error: {e}")
        raise HTTPException(status_code=500, detail=f"System status error: {str(e)}")

@app.get("/system/health", tags=["System"])
def health_check():
    """Health check endpoint for monitoring"""
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat(),
        "uptime": time.time(),
        "version": "2.0.0"
    }

@app.post("/system/boot", tags=["System"])
async def boot_system(role: str = Depends(auth.verify_token)):
    """Boot the ZORA system"""
    if role not in ["admin"]:
        raise HTTPException(status_code=403, detail="Admin access required")
    
    try:
        boot_result = await zora_kernel.boot_sequence()
        return {
            "message": "System boot initiated",
            "boot_success": boot_result,
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"System boot error: {e}")
        raise HTTPException(status_code=500, detail=f"Boot error: {str(e)}")

@app.get("/agents", tags=["Agents"])
def list_agents(role: str = Depends(auth.verify_token)):
    """List all available agents"""
    try:
        agent_status = universal_hub.get_agent_status()
        return {
            "total_agents": len(agent_status),
            "agents": agent_status,
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"List agents error: {e}")
        raise HTTPException(status_code=500, detail=f"Agent listing error: {str(e)}")

@app.get("/agents/{agent_name}", tags=["Agents"])
def get_agent_status(agent_name: str, role: str = Depends(auth.verify_token)):
    """Get status of specific agent"""
    try:
        agent_status = universal_hub.get_agent_status(agent_name)
        if "error" in agent_status:
            raise HTTPException(status_code=404, detail=agent_status["error"])
        return agent_status
    except HTTPException:
        raise
    except Exception as e:
        api_logger.error(f"Agent status error: {e}")
        raise HTTPException(status_code=500, detail=f"Agent status error: {str(e)}")

@app.post("/agents/{agent_name}/ping", tags=["Agents"])
async def ping_agent(agent_name: str, request: AgentPingRequest, role: str = Depends(auth.verify_token)):
    """Ping a specific agent"""
    try:
        ping_result = await universal_hub.ping_agent(agent_name)
        if "error" in ping_result:
            raise HTTPException(status_code=400, detail=ping_result["error"])
        return {
            "agent": agent_name,
            "ping_result": ping_result,
            "timestamp": datetime.utcnow().isoformat()
        }
    except HTTPException:
        raise
    except Exception as e:
        api_logger.error(f"Agent ping error: {e}")
        raise HTTPException(status_code=500, detail=f"Agent ping error: {str(e)}")

@app.post("/coordination/coordinate", tags=["Coordination"])
async def coordinate_agents(request: CoordinationRequest, role: str = Depends(auth.verify_token)):
    """Coordinate agents"""
    try:
        coordination_result = await coordinate_ai_agents(request.agent_group)
        return {
            "coordination_result": coordination_result,
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"Coordination error: {e}")
        raise HTTPException(status_code=500, detail=f"Coordination error: {str(e)}")

@app.post("/coordination/start", tags=["Coordination"])
async def start_coordination(role: str = Depends(auth.verify_token)):
    """Start real-time coordination"""
    if role not in ["admin"]:
        raise HTTPException(status_code=403, detail="Admin access required")
    
    try:
        asyncio.create_task(universal_hub.start_real_time_coordination())
        return {
            "message": "Real-time coordination started",
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"Start coordination error: {e}")
        raise HTTPException(status_code=500, detail=f"Start coordination error: {str(e)}")

@app.post("/coordination/stop", tags=["Coordination"])
def stop_coordination(role: str = Depends(auth.verify_token)):
    """Stop real-time coordination"""
    if role not in ["admin"]:
        raise HTTPException(status_code=403, detail="Admin access required")
    
    try:
        universal_hub.stop_real_time_coordination()
        return {
            "message": "Real-time coordination stopped",
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"Stop coordination error: {e}")
        raise HTTPException(status_code=500, detail=f"Stop coordination error: {str(e)}")

@app.get("/infinity/status", tags=["Infinity"])
def get_infinity_engine_status(role: str = Depends(auth.verify_token)):
    """Get Infinity Engine status"""
    try:
        return get_infinity_status()
    except Exception as e:
        api_logger.error(f"Infinity status error: {e}")
        raise HTTPException(status_code=500, detail=f"Infinity status error: {str(e)}")

@app.post("/infinity/task", tags=["Infinity"])
async def create_infinity_task(request: TaskRequest, role: str = Depends(auth.verify_token)):
    """Create a new infinity task"""
    try:
        priority_map = {
            "critical": TaskPriority.CRITICAL,
            "high": TaskPriority.HIGH,
            "medium": TaskPriority.MEDIUM,
            "low": TaskPriority.LOW,
            "background": TaskPriority.BACKGROUND
        }
        
        priority = priority_map.get(request.priority.lower(), TaskPriority.MEDIUM)
        
        async def api_task():
            return {
                "message": f"API task '{request.name}' executed",
                "metadata": request.metadata,
                "timestamp": datetime.utcnow().isoformat()
            }
        
        task_id = await add_infinity_task(
            name=request.name,
            function=api_task,
            priority=priority,
            metadata=request.metadata
        )
        
        return {
            "task_id": task_id,
            "message": f"Task '{request.name}' created",
            "priority": request.priority,
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"Create task error: {e}")
        raise HTTPException(status_code=500, detail=f"Create task error: {str(e)}")

@app.get("/hub/status", tags=["Hub"])
def get_hub_status(role: str = Depends(auth.verify_token)):
    """Get Universal Hub status"""
    try:
        return get_universal_status()
    except Exception as e:
        api_logger.error(f"Hub status error: {e}")
        raise HTTPException(status_code=500, detail=f"Hub status error: {str(e)}")

@app.get("/hub/control", tags=["Hub"])
def get_control_interface(role: str = Depends(auth.verify_token)):
    """Get hub control interface"""
    try:
        return universal_hub.get_control_interface()
    except Exception as e:
        api_logger.error(f"Control interface error: {e}")
        raise HTTPException(status_code=500, detail=f"Control interface error: {str(e)}")

@app.post("/hub/module", tags=["Hub"])
def register_module(request: ModuleRegistrationRequest, role: str = Depends(auth.verify_token)):
    """Register a new module"""
    if role not in ["admin"]:
        raise HTTPException(status_code=403, detail="Admin access required")
    
    try:
        universal_hub.register_module(request.module_name, request.config)
        return {
            "message": f"Module '{request.module_name}' registered",
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"Module registration error: {e}")
        raise HTTPException(status_code=500, detail=f"Module registration error: {str(e)}")

@app.post("/hub/business", tags=["Hub"])
def integrate_business(request: BusinessIntegrationRequest, role: str = Depends(auth.verify_token)):
    """Integrate a business"""
    if role not in ["admin"]:
        raise HTTPException(status_code=403, detail="Admin access required")
    
    try:
        universal_hub.integrate_business(
            request.business_name, 
            request.ethical_review, 
            request.config
        )
        return {
            "message": f"Business '{request.business_name}' integration processed",
            "ethical_review": request.ethical_review,
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"Business integration error: {e}")
        raise HTTPException(status_code=500, detail=f"Business integration error: {str(e)}")

@app.get("/monitoring/dashboard", tags=["Monitoring"])
def get_dashboard_data(role: str = Depends(auth.verify_token)):
    """Get monitoring dashboard data"""
    try:
        hub_status = get_universal_status()
        dashboard_data = hub_status.get("dashboard", {})
        
        return {
            "dashboard": dashboard_data,
            "system_metrics": {
                "total_agents": hub_status.get("total_agents", 0),
                "coordination_active": hub_status.get("coordination_active", False),
                "infinity_active": infinity_engine.is_running,
                "uptime": hub_status.get("uptime_seconds", 0)
            },
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"Dashboard data error: {e}")
        raise HTTPException(status_code=500, detail=f"Dashboard data error: {str(e)}")

@app.get("/monitoring/metrics", tags=["Monitoring"])
def get_system_metrics(role: str = Depends(auth.verify_token)):
    """Get system performance metrics"""
    try:
        hub_status = get_universal_status()
        infinity_status = get_infinity_status()
        
        return {
            "hub_metrics": hub_status.get("coordination_metrics", {}),
            "infinity_metrics": {
                "cycle_count": infinity_status.get("cycle_count", 0),
                "performance_score": infinity_status.get("performance_score", 0),
                "running_tasks": infinity_status.get("running_tasks", 0),
                "completed_tasks": infinity_status.get("completed_tasks", 0)
            },
            "timestamp": datetime.utcnow().isoformat()
        }
    except Exception as e:
        api_logger.error(f"System metrics error: {e}")
        raise HTTPException(status_code=500, detail=f"System metrics error: {str(e)}")

@app.exception_handler(HTTPException)
async def http_exception_handler(request, exc):
    """Handle HTTP exceptions"""
    api_logger.warning(f"HTTP Exception: {exc.status_code} - {exc.detail}")
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "error": exc.detail,
            "status_code": exc.status_code,
            "timestamp": datetime.utcnow().isoformat()
        }
    )

@app.exception_handler(Exception)
async def general_exception_handler(request, exc):
    """Handle general exceptions"""
    api_logger.error(f"Unhandled exception: {str(exc)}")
    return JSONResponse(
        status_code=500,
        content={
            "error": "Internal server error",
            "message": str(exc),
            "timestamp": datetime.utcnow().isoformat()
        }
    )

if __name__ == "__main__":
    print("ðŸš€ Starting ZORA Core API Server...")
    print("ðŸ“š API Documentation: http://localhost:8000/docs")
    print("ðŸ”§ ReDoc Documentation: http://localhost:8000/redoc")
    
    uvicorn.run(
        "zora:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )
