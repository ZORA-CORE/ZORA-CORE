#!/usr/bin/env python3
# ZORA MODULE HEADER

"""
Module Name: test_universal_connector
Generated by ZORA SYSTEM â€“ All rights reserved.
Test Universal AI System Connector Framework for ZORA CORE
"""

import sys
import os
import json
import asyncio
from datetime import datetime

sys.path.insert(0, '/home/ubuntu/repos/ZORA-CORE')

async def test_universal_connector():
    """Test Universal AI Connector Framework"""
    print("ğŸ§ª TESTING UNIVERSAL AI CONNECTOR FRAMEWORK")
    print("=" * 50)
    
    try:
        from zora_infinity_sync import universal_connector, UniversalAIConnector
        
        print(f"âœ… Successfully imported Universal AI Connector")
        print(f"ğŸ”Œ Connector Name: {universal_connector.name}")
        print(f"ğŸ‘¤ User: {universal_connector.user_name}")
        print(f"ğŸ¢ Organization: {universal_connector.organization}")
        
        print(f"\nğŸ” Testing Auto-Discovery:")
        discovered = universal_connector.auto_discover_ai_systems()
        print(f"  ğŸ“Š Discovered {len(discovered)} AI systems")
        for system in discovered[:5]:  # Show first 5
            print(f"    âœ… {system}")
        
        print(f"\nğŸ“ Testing System Registration:")
        test_system = {
            "base_url": "https://api.test-ai.com/v1",
            "auth_type": "bearer",
            "capabilities": ["test_capability", "demo_feature"]
        }
        
        success = universal_connector.register_ai_system("test_ai", test_system)
        print(f"  Registration Success: {'âœ…' if success else 'âŒ'}")
        
        print(f"\nğŸ”§ Testing Integration Patterns:")
        pattern = universal_connector.create_universal_integration_pattern("test_ai")
        print(f"  Pattern Created: {'âœ…' if pattern else 'âŒ'}")
        print(f"  Authentication Method: {pattern.get('authentication', {}).get('method', 'N/A')}")
        print(f"  Monitoring Enabled: {pattern.get('monitoring', {}).get('performance_tracking', False)}")
        
        print(f"\nğŸ”— Testing AI System Connections:")
        test_systems = ["openai", "anthropic", "nvidia", "test_ai"]
        
        for system in test_systems:
            try:
                connected = await universal_connector.connect_to_ai_system(system)
                status = "âœ… Connected" if connected else "âš ï¸ Failed"
                print(f"  {system}: {status}")
            except Exception as e:
                print(f"  {system}: âŒ Error - {e}")
        
        print(f"\nğŸ“Š Testing Connector Status:")
        status = universal_connector.get_connector_status()
        print(f"  Total Systems: {status.get('total_registered_systems', 0)}")
        print(f"  Connected Systems: {status.get('connected_systems', 0)}")
        print(f"  Connection Rate: {status.get('connection_rate', 0):.1f}%")
        print(f"  Integration Patterns: {status.get('integration_patterns', 0)}")
        
        print(f"\nğŸ‰ UNIVERSAL CONNECTOR TEST COMPLETED")
        return True
        
    except ImportError as e:
        print(f"âŒ Import Error: {e}")
        return False
    except Exception as e:
        print(f"âŒ Test Error: {e}")
        return False

async def test_api_manager():
    """Test Universal API Manager"""
    print(f"\nğŸ”‘ TESTING UNIVERSAL API MANAGER")
    print("=" * 50)
    
    try:
        from sync_utils import api_manager, UniversalAPIManager
        
        print(f"âœ… Successfully imported Universal API Manager")
        print(f"ğŸ”§ Manager Name: {api_manager.name}")
        print(f"ğŸ‘¤ User: {api_manager.user_name}")
        print(f"ğŸ¢ Organization: {api_manager.organization}")
        
        print(f"\nğŸ“ Testing Credential Registration:")
        test_creds = {
            "api_key": "test_key_12345",
            "auth_type": "bearer"
        }
        
        success = api_manager.register_api_credentials("test_service", test_creds)
        print(f"  Registration Success: {'âœ…' if success else 'âŒ'}")
        
        print(f"\nğŸ” Testing Auth Headers:")
        headers = api_manager.get_auth_headers("test_service")
        print(f"  Headers Generated: {'âœ…' if headers else 'âŒ'}")
        print(f"  Authorization Header: {'âœ…' if 'Authorization' in headers else 'âŒ'}")
        print(f"  ZORA Headers: {'âœ…' if 'X-ZORA-User' in headers else 'âŒ'}")
        
        print(f"\nğŸ” Testing Credential Auto-Discovery:")
        discovered = api_manager.auto_discover_credentials()
        print(f"  Discovered Credentials: {len(discovered)}")
        for cred in discovered[:3]:  # Show first 3
            print(f"    ğŸ”‘ {cred}")
        
        return True
        
    except Exception as e:
        print(f"âŒ API Manager Test Error: {e}")
        return False

async def test_enhanced_repair_engine():
    """Test Enhanced Repair Engine"""
    print(f"\nğŸ”§ TESTING ENHANCED REPAIR ENGINE")
    print("=" * 50)
    
    try:
        from sync_utils import repair_engine, ZoraRepairEngine
        
        print(f"âœ… Successfully imported Enhanced Repair Engine")
        print(f"ğŸ‘¤ User: {repair_engine.user_name}")
        print(f"ğŸ¢ Organization: {repair_engine.organization}")
        
        print(f"\nğŸ” Testing Error Diagnosis:")
        test_errors = [
            Exception("API key authentication failed"),
            Exception("Connection timeout occurred"),
            Exception("Rate limit exceeded"),
            Exception("Unknown endpoint error")
        ]
        
        for i, error in enumerate(test_errors):
            diagnosis = repair_engine.diagnose_agent_failure(f"test_agent_{i}", error)
            strategy = diagnosis.get("repair_strategy", "unknown")
            severity = diagnosis.get("severity", "unknown")
            print(f"  Error {i+1}: {strategy} (severity: {severity})")
        
        print(f"\nğŸ› ï¸ Testing Repair Attempts:")
        for i in range(2):
            try:
                success = await repair_engine.attempt_repair(f"test_agent_{i}", "api_key_refresh")
                status = "âœ… Success" if success else "âŒ Failed"
                print(f"  Repair Agent {i}: {status}")
            except Exception as e:
                print(f"  Repair Agent {i}: âŒ Error - {e}")
        
        return True
        
    except Exception as e:
        print(f"âŒ Repair Engine Test Error: {e}")
        return False

if __name__ == "__main__":
    print("ğŸš€ ZORA CORE UNIVERSAL CONNECTOR TEST SUITE")
    print(f"â° Test started at: {datetime.utcnow().isoformat()}Z")
    print()
    
    async def run_all_tests():
        test1_result = await test_universal_connector()
        test2_result = await test_api_manager()
        test3_result = await test_enhanced_repair_engine()
        
        print("\n" + "=" * 50)
        print("ğŸ“Š TEST RESULTS SUMMARY:")
        print(f"  Universal Connector: {'âœ… PASSED' if test1_result else 'âŒ FAILED'}")
        print(f"  API Manager: {'âœ… PASSED' if test2_result else 'âŒ FAILED'}")
        print(f"  Enhanced Repair Engine: {'âœ… PASSED' if test3_result else 'âŒ FAILED'}")
        
        if test1_result and test2_result and test3_result:
            print("\nğŸ‰ ALL TESTS PASSED - UNIVERSAL CONNECTOR READY FOR ZORA CORE")
        else:
            print("\nâš ï¸ SOME TESTS FAILED - CHECK INTEGRATION")
        
        print(f"\nâ° Test completed at: {datetime.utcnow().isoformat()}Z")
    
    asyncio.run(run_all_tests())
