# ZORA MODULE HEADER

"""
Module Name: mistral
Generated by ZORA SYSTEM â€“ All rights reserved.
Mistral AI Agent Integration
"""

import os
import time
import json
import asyncio
from typing import Dict, Any, List, Optional
import requests
from .base_agent import BaseAgent

try:
    from eivor_ai_family_system import birth_ai_agent, eivor_family_system
    EIVOR_FAMILY_AVAILABLE = True
except ImportError:
    EIVOR_FAMILY_AVAILABLE = False
    birth_ai_agent = None
    eivor_family_system = None

class MistralAgent(BaseAgent):
    """Enhanced Mistral AI Agent for ZORA CORE with full Mistral API integration"""

    def __init__(self):
        super().__init__(
            name="mistral",
            api_key=os.getenv("MISTRAL_API_KEY"),
            model="mistral-large-latest",
            endpoint="https://api.mistral.ai/v1/chat/completions",
            capabilities=["reasoning", "analysis", "code_generation", "conversation", "long_context"],
            max_requests=60,
            timeout=60
        )
        self.max_tokens = 4096
        self._eivor_registered = False

    async def _register_with_eivor_family(self):
        """Register Mistral agent with EIVOR AI Family System"""
        try:
            if birth_ai_agent and not hasattr(self, '_family_registered'):
                await birth_ai_agent(
                    "mistral",
                    self,
                    capabilities=self.capabilities,
                    personality_traits={"traits": ["creative", "fast", "open"], "voice_personality": "MISTRAL"}
                )
                self._family_registered = True
                self.logger.info("ðŸ¤– Mistral registered with EIVOR AI Family System")
        except Exception as e:
            self.logger.error(f"Failed to register with EIVOR family: {e}")

    def ping(self, message: str) -> Dict[str, Any]:
        """Ping with actual Mistral API validation"""
        start_time = time.time()
        try:
            if EIVOR_FAMILY_AVAILABLE and not self._eivor_registered:
                try:
                    asyncio.run(self._register_with_eivor_family())
                    self._eivor_registered = True
                except Exception as e:
                    self.logger.error(f"Failed to register with EIVOR family: {e}")

            self.last_ping = start_time

            if not self.api_key:
                return self.handle_error(Exception("Mistral API key not configured"), "ping")

            if not self.rate_limiter.can_make_request():
                return self.handle_error(Exception("Rate limit exceeded"), "ping")

            headers = {
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            }

            test_payload = {
                "model": self.model,
                "max_tokens": 100,
                "messages": [
                    {"role": "user", "content": f"Respond with 'ZORA SYNC CONFIRMED: {message}' to verify connectivity"}
                ]
            }

            self.rate_limiter.record_request()
            response = requests.post(
                self.endpoint,
                headers=headers,
                json=test_payload,
                timeout=self.timeout
            )

            response_time = time.time() - start_time

            if response.status_code == 200:
                api_response = response.json()
                content = api_response.get("choices", [{}])[0].get("message", {}).get("content", "")

                response_data = {
                    "agent": "mistral",
                    "message": f"ðŸŒ¬ï¸ Mistral AGI responding to: {message}",
                    "api_response": content,
                    "status": "synchronized",
                    "model": self.model,
                    "timestamp": self.last_ping,
                    "response_time": response_time,
                    "capabilities": self.capabilities,
                    "usage": api_response.get("usage", {}),
                    "infinity_ready": True
                }

                self.update_performance_metrics(response_time, True)
                self.log_activity("ping_successful", response_data)
                return response_data
            else:
                error_msg = f"API error: {response.status_code} - {response.text}"
                self.update_performance_metrics(response_time, False)
                return self.handle_error(Exception(error_msg), "ping")

        except requests.exceptions.Timeout:
            response_time = time.time() - start_time
            self.update_performance_metrics(response_time, False)
            return self.handle_error(Exception("Request timeout"), "ping")
        except requests.exceptions.ConnectionError:
            response_time = time.time() - start_time
            self.update_performance_metrics(response_time, False)
            return self.handle_error(Exception("Connection error"), "ping")
        except Exception as e:
            response_time = time.time() - start_time
            self.update_performance_metrics(response_time, False)
            return self.handle_error(e, "ping")

    async def process_request(self, request: Dict[str, Any]) -> Dict[str, Any]:
        """Process strategic request from ZORA INFINITY ENGINEâ„¢ with Mistral's advanced reasoning"""
        start_time = time.time()
        try:
            if not self.api_key:
                return self.handle_error(Exception("Mistral API key not configured"), "process_request")

            if not self.rate_limiter.can_make_request():
                await asyncio.sleep(2)
                if not self.rate_limiter.can_make_request():
                    return self.handle_error(Exception("Rate limit exceeded"), "process_request")

            messages = request.get("messages", [])
            task_type = request.get("task_type", "reasoning")
            context = request.get("context", {})

            headers = {
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            }

            payload = {
                "model": self.model,
                "max_tokens": request.get("max_tokens", self.max_tokens),
                "messages": messages,
                "stream": False
            }

            self.rate_limiter.record_request()

            loop = asyncio.get_event_loop()
            response = await loop.run_in_executor(
                None,
                lambda: requests.post(self.endpoint, headers=headers, json=payload, timeout=self.timeout)
            )

            response_time = time.time() - start_time

            if response.status_code == 200:
                api_response = response.json()
                result = {
                    "agent": "mistral",
                    "task_type": task_type,
                    "status": "completed",
                    "response": {
                        "content": api_response.get("choices", [{}])[0].get("message", {}).get("content", ""),
                        "role": "assistant"
                    },
                    "usage": api_response.get("usage", {}),
                    "model": self.model,
                    "response_time": response_time,
                    "timestamp": time.time(),
                    "context": context
                }

                self.update_performance_metrics(response_time, True)
                self.log_activity("request_processed", result)
                await self.sync_with_infinity_engine(result)
                return result
            else:
                error_msg = f"API error: {response.status_code} - {response.text}"
                self.update_performance_metrics(response_time, False)
                return self.handle_error(Exception(error_msg), "process_request")

        except Exception as e:
            response_time = time.time() - start_time
            self.update_performance_metrics(response_time, False)
            return self.handle_error(e, "process_request")

mistral = MistralAgent()
